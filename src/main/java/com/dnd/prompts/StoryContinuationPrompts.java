package com.dnd.prompts;

import java.util.Map;

/**
 * Промпты для генерации продолжения истории после действий игрока
 */
public class StoryContinuationPrompts {
    
    /**
     * Промпт для генерации продолжения истории после действия игрока
     * DM должен продолжить сюжет: развить квест, организовать встречу с NPC, создать событие и т.д.
     */
    public static String getStoryContinuationPrompt(String playerAction, String dmResponse, 
                                                   String characterName, String characterClass, String characterRace,
                                                   String currentLocation,
                                                   Map<String, Object> questInfo, String relevantContext) {
        StringBuilder questContext = new StringBuilder();
        if (questInfo != null) {
            String currentStage = (String) questInfo.getOrDefault("current_stage", "");
            String goal = (String) questInfo.getOrDefault("goal", "");
            String title = (String) questInfo.getOrDefault("title", "");
            questContext.append(String.format("""
            
            ТЕКУЩИЙ КВЕСТ:
            Название: %s
            Цель: %s
            Текущий этап: %s
            
            Продолжение истории должно развивать квест и продвигать сюжет к цели.
            """, title, goal, currentStage));
        }
        
        // Добавляем релевантный контекст, если он есть
        String contextSection = "";
        if (relevantContext != null && !relevantContext.isEmpty()) {
            contextSection = String.format("""
            
            === РЕЛЕВАНТНЫЙ КОНТЕКСТ ===
            %s
            
            ВАЖНО: Используй эту информацию при создании продолжения. Продолжение должно логически вытекать из событий квеста и учитывать связанных NPC, локации и предметы.
            """, relevantContext);
        }
        
        String locationContext = currentLocation != null && !currentLocation.isEmpty() 
            ? String.format("\nТекущая локация: %s", currentLocation) 
            : "";
        
        // Получаем описание расы для контекста
        String raceDescription = getRaceDescription(characterRace);
        String characterInfo = String.format("""
            Персонаж: %s
            Класс: %s
            Раса: %s
            %s
            """, characterName, characterClass, characterRace, raceDescription);
        
        return String.format("""
            Ты — опытный Dungeon Master для D&D 5e. Твоя задача — продолжить историю после действия игрока.
            
            Действие игрока: "%s"
            Ответ DM на действие: "%s"
            
            %s
            %s
            %s
            
            Создай ПРОДОЛЖЕНИЕ ИСТОРИИ, которое развивает сюжет. Это может быть:
            
            1. РАЗВИТИЕ КВЕСТА - продвижение к следующему этапу, новое препятствие, ключевое событие
            2. ВСТРЕЧА С NPC - новый персонаж появляется, диалог, важная информация
            3. СЛУЧАЙНОЕ СОБЫТИЕ - неожиданное происшествие, которое влияет на историю
            4. НОВАЯ ЛОКАЦИЯ - переход в новое место, открытие нового пространства
            5. ПРЕПЯТСТВИЕ - новая задача, которую нужно решить
            6. РАСКРЫТИЕ ТАЙНЫ - важная информация, которая меняет понимание ситуации
            
            ОБЯЗАТЕЛЬНО:
            - Продолжение должно логически вытекать из действия игрока и ответа DM
            - Создай ситуацию, которая требует от персонажа следующего действия
            - Будь конкретным и атмосферным
            - Используй детали окружения и мира
            - Если есть квест, продвигай его сюжет
            - Включай сенсорные детали (что видит, слышит, чувствует персонаж)
            
            НЕ просто описывай результат действия - СОЗДАЙ НОВУЮ СИТУАЦИЮ, которая требует следующего действия.
            
            Верни ответ ТОЛЬКО в формате JSON (без дополнительного текста):
            {
                "message_type": "situation_continuation" | "npc_encounter" | "random_event" | "quest_progression" | "exploration_event" | "location_description",
                "content": "Детальное описание продолжения истории",
                "location": "Название локации",
                "metadata": {
                    "quest_stage": "Текущий этап квеста (если есть)",
                    "event_type": "Тип события (если применимо)"
                },
                "analysis": {
                    "npcs_mentioned": ["список имен NPC, которые упоминались или появились"],
                    "locations_mentioned": ["список локаций, к которым относится сообщение"],
                    "quests_mentioned": ["список названий квестов, которые были начаты или к которым относится сообщение"],
                    "key_events": ["список ключевых событий, которые произошли"],
                    "connections": ["список связей между событиями, персонажами, локациями"],
                    "new_information": {
                        "npcs": [
                            {
                                "name": "имя NPC",
                                "description": "описание NPC (если новый или обновлен)",
                                "location": "текущая локация NPC (где он находится сейчас)",
                                "home_location": "домашняя локация NPC (где он живет/базируется, может отличаться от текущей)"
                            }
                        ],
                        "locations": [
                            {
                                "name": "название локации",
                                "description": "описание локации (если новая или обновлена)"
                            }
                        ],
                        "quests": [
                            {
                                "title": "название квеста",
                                "description": "описание квеста (если новый или обновлен)",
                                "type": "main" | "side"
                            }
                        ]
                    }
                }
            }
            
            ВАЖНО: 
            - message_type должен соответствовать типу продолжения (situation_continuation, npc_encounter, random_event и т.д.)
            - content - это детальное описание продолжения истории, которое требует следующего действия
            - location - название локации
            - metadata - дополнительные данные
            - analysis - анализ сказанного (заполняй только если есть что анализировать, иначе можешь опустить или оставить пустым)
            - В analysis включай только релевантную информацию: новые NPC, локации, квесты или важные упоминания
            - Уточняю: не нужно писать всё подряд, пишем только важных npc, продумывай их историю и значимость
            - Если локация находится в другой локации. Например: город Лордран, страна Ильбум; или таверна "дикий крот", город Лордран
            - Если ничего нового не произошло, можешь опустить поле analysis или оставить его пустым
            - Учитывай расу и класс персонажа при создании продолжения истории. Например:
              * Эльфы могут иметь особую связь с природой и магией
              * Дварфы могут быть связаны с подземельями и ремеслом
              * Тифлинги могут вызывать особые реакции у NPC из-за их демонического происхождения
              * Класс персонажа влияет на то, как он воспринимается в мире (маги, воины, жрецы и т.д.)
            %s
            """, playerAction, dmResponse, characterInfo, locationContext, questContext, contextSection);
    }
    
    /**
     * Возвращает описание расы для использования в промпте
     */
    private static String getRaceDescription(String race) {
        if (race == null || race.isEmpty()) {
            return "";
        }
        
        String raceLower = race.toLowerCase();
        return switch (raceLower) {
            case "dragonborn" -> """
                Раса: Драконорожденные (Dragonborn)
                Драконорожденные - потомки драконов, обладающие драконьей кровью. Они часто вызывают удивление или страх у обычных людей.
                Могут дышать огнем (или другим элементом в зависимости от предка-дракона). Обычно гордые и решительные.
                """;
            case "dwarf" -> """
                Раса: Дварфы (Dwarves)
                Дварфы - мастера ремесла и горного дела. Обычно живут в подземных городах и крепостях.
                Обладают темновидением, устойчивостью к ядам и магии. Ценят традиции, семью и клан.
                """;
            case "elf" -> """
                Раса: Эльфы (Elves)
                Эльфы - древняя раса, тесно связанная с природой и магией. Живут очень долго (сотни лет).
                Обладают темновидением, иммунитетом к магическому сну, острой интуицией. Часто живут в лесах или эльфийских городах.
                """;
            case "gnome" -> """
                Раса: Гномы (Gnomes)
                Гномы - маленькие, любопытные существа, любящие изобретения и магию. Обычно дружелюбны и оптимистичны.
                Обладают темновидением и устойчивостью к магии. Часто живут в подземных общинах или среди других рас.
                """;
            case "half_elf", "half-elf" -> """
                Раса: Полуэльфы (Half-Elves)
                Полуэльфы - потомки эльфов и людей. Обладают долголетием эльфов, но более гибкие и адаптивные.
                Часто чувствуют себя чужими и в эльфийском, и в человеческом обществе. Хорошие дипломаты.
                """;
            case "halfling" -> """
                Раса: Полурослики (Halflings)
                Полурослики - маленькие, проворные существа, известные своей удачей и любовью к комфорту.
                Обычно дружелюбны, любят хорошую еду и уют. Обладают устойчивостью к страху.
                """;
            case "half_orc", "half-orc" -> """
                Раса: Полуорки (Half-Orcs)
                Полуорки - потомки орков и людей. Обладают физической силой и выносливостью.
                Часто сталкиваются с предрассудками из-за своего происхождения. Могут впадать в ярость в бою.
                """;
            case "human" -> """
                Раса: Люди (Humans)
                Люди - самая разнообразная и распространенная раса. Адаптивные и амбициозные.
                Не обладают особыми расовыми способностями, но компенсируют это разнообразием и амбициями.
                """;
            case "tiefling" -> """
                Раса: Тифлинги (Tieflings)
                Тифлинги - потомки людей и демонов или дьяволов. Имеют рога, хвост и необычный цвет кожи.
                Часто сталкиваются с предрассудками и страхом из-за своего демонического происхождения.
                Обладают врожденной магией и устойчивостью к огню.
                """;
            default -> "";
        };
    }
}

