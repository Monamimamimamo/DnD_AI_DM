package com.dnd.prompts;

import java.util.HashMap;
import java.util.Map;

/**
 * Промпты для генерации мира и квестов
 */
public class WorldPrompts {
    
    /**
     * Промпт для генерации мира кампании
     */
    public static String getWorldBuildingPrompt() {
        return """
        Создай детальный и проработанный мир для кампании D&D 5e.
        
        ОБЯЗАТЕЛЬНО включи:
        
        1. ОПИСАНИЕ МИРА:
           - География: континенты, регионы, климат
           - Политическая система: королевства, города, правители
           - Магическая система: как работает магия в этом мире
           - История: ключевые события, войны, легенды
           - Культура: расы, народы, традиции, религии
        
        2. ОСНОВНАЯ ЛОКАЦИЯ (где начинается приключение):
           - Детальное описание места (город, деревня, замок и т.д.)
           - Важные NPC и их роли
           - Проблемы и конфликты в этой локации
           - Интересные места для исследования
        
        3. АТМОСФЕРА И ТОН:
           - Общий настрой кампании (мрачный, героический, загадочный и т.д.)
           - Стиль приключения
        
        Верни ответ ТОЛЬКО в формате JSON (без дополнительного текста):
        {
            "world_description": "Детальное описание мира",
            "main_location": {
                "name": "Название основной локации",
                "description": "Детальное описание локации",
                "important_npcs": ["NPC 1 и его роль", "NPC 2 и его роль"],
                "problems": ["Проблема 1", "Проблема 2"],
                "points_of_interest": ["Место 1", "Место 2"]
            },
            "atmosphere": "Описание атмосферы и тона кампании",
            "history": "Ключевые исторические события"
        }
        
        КРИТИЧЕСКИ ВАЖНО:
        - Мир должен быть детальным и проработанным
        - Описания должны быть развернутыми (не краткие!)
        - Мир должен создавать основу для масштабного приключения
        - Отвечай ТОЛЬКО валидным JSON, без дополнительного текста
        """;
    }
    
    /**
     * Промпт для генерации начальной сцены, квеста и начальной ситуации с учетом мира
     */
    public static String getInitialSceneQuestAndSituationPrompt(Map<String, Object> world) {
        StringBuilder worldContext = new StringBuilder();
        if (world != null) {
            String worldDesc = (String) world.getOrDefault("world_description", "");
            String atmosphere = (String) world.getOrDefault("atmosphere", "");
            @SuppressWarnings("unchecked")
            Map<String, Object> mainLocation = (Map<String, Object>) world.getOrDefault("main_location", new HashMap<>());
            String locationName = (String) mainLocation.getOrDefault("name", "");
            String locationDesc = (String) mainLocation.getOrDefault("description", "");
            
            worldContext.append(String.format("""
            
            КОНТЕКСТ МИРА:
            Описание мира: %s
            Атмосфера: %s
            Основная локация: %s
            Описание локации: %s
            
            Начальная сцена должна логически вписываться в этот мир и использовать информацию о локации.
            """, worldDesc, atmosphere, locationName, locationDesc));
        }
        
        return String.format("""
        Создай увлекательное начало приключения D&D 5e с начальной ситуацией и основным квестом для группы искателей приключений.
        %s
        
        ВАЖНО: Ситуация должна ПОДТОЛКНУТЬ игроков к действию через описание истории и обстоятельств, а квест должен быть ВЫВОДОМ из этой ситуации.
        
        Структура:
        
        1. СИТУАЦИЯ (детальное описание, которое подталкивает к действию):
           - ДЕТАЛЬНОЕ и КОНКРЕТНОЕ описание ситуации для ВСЕЙ ГРУППЫ
           - ОБЯЗАТЕЛЬНО включи:
             * ТОЧНУЮ ЛОКАЦИЮ - где именно находится группа (детальное описание места, используй информацию о локации из мира)
             * ДЕТАЛЬНОЕ ОПИСАНИЕ ОКРУЖЕНИЯ - что группа видит вокруг (конкретные объекты, препятствия, детали, атмосфера)
             * СЕНСОРНЫЕ ДЕТАЛИ - что группа слышит, чувствует, ощущает
             * КОНКРЕТНЫЕ ВАРИАНТЫ - что можно сделать (например: "Перед вами три двери: северная, восточная и западная", "Река шириной 5 метров, через которую перекинут шаткий мост")
             * ЧЕТКИЕ УСЛОВИЯ - что нужно преодолеть или решить
             * КОНТЕКСТ МИРА - как эта ситуация связана с большим миром
           - Ситуация должна быть описанием истории/обстоятельств, которые естественным образом требуют действия
           - Используй формулировки "вы", "ваша группа", "вы все" - ситуация для ВСЕЙ ГРУППЫ
           - НЕ раскрывай квест напрямую - пусть игроки сами поймут, что нужно делать из контекста ситуации
        
        2. КВЕСТ (как заключение/вывод из ситуации):
           - Квест должен быть ВЫВОДОМ из описанной ситуации
           - Это может быть цель персонажей, эмоциональная ситуация, из которой делаются выводы
           - Квест должен быть МАСШТАБНЫМ (не простой задачей, а полноценным приключением)
           - Квест должен решать проблему или раскрывать тайну, связанную с миром
           - Квест должен вести через разные локации и ситуации
           - В "quest_summary" опиши квест как краткое подытоживание ситуации, а не как прямую инструкцию
        
        Верни ответ ТОЛЬКО в формате JSON (без дополнительного текста):
        {
            "situation": "Детальное описание ситуации для ВСЕЙ ГРУППЫ, которая подталкивает к действию через описание истории и обстоятельств",
            "quest": {
                "title": "Название квеста",
                "goal": "Главная цель квеста",
                "stages": ["Этап 1", "Этап 2", "Этап 3", "Этап 4", "Этап 5", "Этап 6", "Этап 7"],
                "description": "Развернутое описание квеста (как он связан с миром)",
                "quest_summary": "Краткое подытоживание ситуации в виде квеста - цель персонажей или эмоциональная ситуация, из которой делаются выводы. Это заключение из ситуации, а не прямая инструкция."
            },
            "initial_location": "Название начальной локации"
        }
        
        КРИТИЧЕСКИ ВАЖНО:
        - Ситуация должна ПОДТОЛКНУТЬ игроков к действию через описание истории/обстоятельств
        - Квест должен быть ВЫВОДОМ из ситуации, а не прямой инструкцией
        - quest_summary - это подытоживание ситуации в виде квеста (цель персонажей или эмоциональная ситуация)
        - Начальная ситуация должна быть для ВСЕЙ ГРУППЫ
        - Начальная ситуация должна использовать информацию о мире и локации
        - Отвечай ТОЛЬКО валидным JSON, без дополнительного текста
        """, worldContext.toString());
    }
    
    /**
     * Промпт для генерации финальной сцены при завершении квеста
     */
    public static String getFinalScenePrompt(String questTitle, String questGoal) {
        return String.format("""
        Квест "%s" завершен!
        Цель квеста: %s
        
        Создай эпическую финальную сцену, которая:
        1. Показывает последствия выполнения квеста
        2. Подводит итоги приключения
        3. Дает ощущение завершенности истории
        4. Может намекать на возможные продолжения
        
        Верни ответ ТОЛЬКО в формате JSON (без дополнительного текста):
        {
            "message_type": "final_scene",
            "content": "Эпическая финальная сцена (атмосферно и эмоционально)",
            "metadata": {
                "quest_title": "%s",
                "quest_goal": "%s",
                "consequences": "Последствия выполнения квеста",
                "hints_for_continuation": "Намеки на возможные продолжения (если есть)"
            }
        }
        
        ВАЖНО:
        - message_type должен быть "final_scene"
        - content - детальное описание финальной сцены
        - metadata - информация о завершенном квесте
        """, questTitle, questGoal, questTitle, questGoal);
    }
}

