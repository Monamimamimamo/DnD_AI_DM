package com.dnd.prompts;

import java.util.HashMap;
import java.util.Map;

/**
 * Промпты для генерации мира и квестов
 */
public class WorldPrompts {
    
    /**
     * Промпт для генерации мира кампании
     */
    public static String getWorldBuildingPrompt(com.dnd.game_state.SessionDuration sessionDuration) {
        String scopeInstruction;
        String detailLevel;
        String worldSize;
        String locationScope;
        
        switch (sessionDuration) {
            case SHORT:
                scopeInstruction = """
                КОРОТКАЯ СЕССИЯ (~4 часа):
                - Создай МАЛЕНЬКИЙ ГОРОДОК с несколькими ключевыми точками
                - Мир должен быть прописан, но НЕ ОГРОМЕН
                - Сфокусируйся на одной локации и её ближайших окрестностях
                - Ограничься 3-5 важными NPC
                - Создай 2-3 интересных места для исследования
                - История должна быть локальной, связанной с этим местом
                """;
                detailLevel = "умеренный";
                worldSize = "маленький городок";
                locationScope = "одна локация с несколькими ключевыми точками";
                break;
            case MEDIUM:
                scopeInstruction = """
                СРЕДНЯЯ СЕССИЯ (~30-40 часов):
                - Создай средний по размеру мир
                - Включи несколько локаций (город, окрестности, несколько важных мест)
                - Создай 5-8 важных NPC
                - Создай 4-6 интересных мест для исследования
                - История должна охватывать регион
                """;
                detailLevel = "высокий";
                worldSize = "регион с несколькими локациями";
                locationScope = "несколько связанных локаций";
                break;
            case LONG:
                scopeInstruction = """
                ДЛИННАЯ СЕССИЯ (не ограничена временем):
                - Создай ОГРОМНЫЙ прописанный мир
                - Включи множество локаций, континентов, регионов
                - Создай множество важных NPC (10+)
                - Создай множество интересных мест для исследования
                - История должна быть глобальной, с множеством слоев
                - Уровень детализации МАКСИМАЛЕН
                """;
                detailLevel = "максимальный";
                worldSize = "огромный мир";
                locationScope = "множество локаций, континентов, регионов";
                break;
            default:
                scopeInstruction = "";
                detailLevel = "высокий";
                worldSize = "регион";
                locationScope = "несколько локаций";
        }
        
        return String.format("""
        Создай %s и проработанный мир для кампании D&D 5e.
        
        %s
        
        ОБЯЗАТЕЛЬНО включи:
        
        1. ОПИСАНИЕ МИРА:
           - География: %s
           - Политическая система: королевства, города, правители (масштаб зависит от длительности сессии)
           - Магическая система: как работает магия в этом мире
           - История: ключевые события, войны, легенды (масштаб зависит от длительности сессии)
           - Культура: расы, народы, традиции, религии
        
        2. ОСНОВНАЯ ЛОКАЦИЯ (где начинается приключение):
           - Детальное описание места (город, деревня, замок и т.д.)
           - Важные NPC и их роли (количество зависит от длительности сессии)
           - Проблемы и конфликты в этой локации
           - Интересные места для исследования (количество зависит от длительности сессии)
        
        3. АТМОСФЕРА И ТОН:
           - Общий настрой кампании (мрачный, героический, загадочный и т.д.)
           - Стиль приключения
        
        Верни ответ ТОЛЬКО в формате JSON (без дополнительного текста):
        {
            "world_description": "Детальное описание мира (масштаб зависит от длительности сессии)",
            "main_location": {
                "name": "Название основной локации",
                "description": "Детальное описание локации",
                "important_npcs": ["NPC 1 и его роль", "NPC 2 и его роль"],
                "problems": ["Проблема 1", "Проблема 2"],
                "points_of_interest": ["Место 1", "Место 2"]
            },
            "atmosphere": "Описание атмосферы и тона кампании",
            "history": "Ключевые исторические события"
        }
        
        КРИТИЧЕСКИ ВАЖНО:
        - Мир должен быть проработанным с учетом длительности сессии
        - Описания должны быть развернутыми (уровень детализации: %s)
        - Масштаб мира должен соответствовать длительности сессии
        - Отвечай ТОЛЬКО валидным JSON, без дополнительного текста
        """, detailLevel, scopeInstruction, locationScope, detailLevel);
    }
    
    /**
     * Промпт для генерации начальной сцены, квеста и начальной ситуации с учетом мира
     */
    public static String getInitialSceneQuestAndSituationPrompt(Map<String, Object> world, com.dnd.game_state.SessionDuration sessionDuration) {
        StringBuilder worldContext = new StringBuilder();
        if (world != null) {
            String worldDesc = (String) world.getOrDefault("world_description", "");
            String atmosphere = (String) world.getOrDefault("atmosphere", "");
            @SuppressWarnings("unchecked")
            Map<String, Object> mainLocation = (Map<String, Object>) world.getOrDefault("main_location", new HashMap<>());
            String locationName = (String) mainLocation.getOrDefault("name", "");
            String locationDesc = (String) mainLocation.getOrDefault("description", "");
            
            worldContext.append(String.format("""
            
            КОНТЕКСТ МИРА:
            Описание мира: %s
            Атмосфера: %s
            Основная локация: %s
            Описание локации: %s
            
            Начальная сцена должна логически вписываться в этот мир и использовать информацию о локации.
            """, worldDesc, atmosphere, locationName, locationDesc));
        }
        
        String questScopeInstruction;
        String questStagesCount;
        
        switch (sessionDuration) {
            case SHORT:
                questScopeInstruction = """
                КОРОТКАЯ СЕССИЯ (~4 часа):
                - Квест должен быть ЛОКАЛЬНЫМ, связанным с маленьким городком
                - Квест должен быть ЗАВЕРШАЕМЫМ за ~4 часа игры
                - Сфокусируйся на одной проблеме в локации
                - Квест должен вести через несколько ключевых точек в городке
                - После завершения квеста игроки могут исследовать оставшиеся локации, но последствия квеста должны отражаться в мире
                """;
                questStagesCount = "3-5";
                break;
            case MEDIUM:
                questScopeInstruction = """
                СРЕДНЯЯ СЕССИЯ (~30-40 часов):
                - Квест должен быть РЕГИОНАЛЬНЫМ, охватывающим несколько локаций
                - Квест должен быть рассчитан на ~30-40 часов игры
                - Квест должен вести через несколько связанных локаций
                - После завершения основного квеста игроки могут доделать все квесты и открыть все локации, но последствия завершённых квестов должны находить отражение в мире
                """;
                questStagesCount = "6-10";
                break;
            case LONG:
                questScopeInstruction = """
                ДЛИННАЯ СЕССИЯ (не ограничена временем):
                - Квест должен быть ГЛОБАЛЬНЫМ, охватывающим огромный мир
                - Квест должен быть рассчитан на долгую игру без временных ограничений
                - Квест должен вести через множество локаций, континентов, регионов
                - Квест должен быть многослойным, с множеством этапов
                - После завершения основного квеста игроки могут доделать все квесты и открыть все локации, но последствия завершённых квестов должны находить отражение в мире
                """;
                questStagesCount = "10+";
                break;
            default:
                questScopeInstruction = "";
                questStagesCount = "6-8";
        }
        
        return String.format("""
        Создай увлекательное начало приключения D&D 5e с начальной ситуацией и основным квестом для группы искателей приключений.
        %s
        
        %s
        
        ВАЖНО: Ситуация должна ПОДТОЛКНУТЬ игроков к действию через описание истории и обстоятельств, а квест должен быть ВЫВОДОМ из этой ситуации.
        
        Структура:
        
        1. СИТУАЦИЯ (детальное описание, которое подталкивает к действию):
           - ДЕТАЛЬНОЕ и КОНКРЕТНОЕ описание ситуации для ВСЕЙ ГРУППЫ
           - ОБЯЗАТЕЛЬНО включи:
             * ТОЧНУЮ ЛОКАЦИЮ - где именно находится группа (детальное описание места, используй информацию о локации из мира)
             * ДЕТАЛЬНОЕ ОПИСАНИЕ ОКРУЖЕНИЯ - что группа видит вокруг (конкретные объекты, препятствия, детали, атмосфера)
             * СЕНСОРНЫЕ ДЕТАЛИ - что группа слышит, чувствует, ощущает
             * КОНКРЕТНЫЕ ВАРИАНТЫ ДЕЙСТВИЙ - что можно сделать, но ТОЛЬКО если это логично вписывается в описанную локацию (это может быть какая то ситуация в таверне, или встреча в лесу, или конфликт на улицах. Что-то подобное, придумай сам)
             * КОНТЕКСТ МИРА - как эта ситуация связана с большим миром
           - Ситуация должна быть ЕДИНЫМ ЦЕЛЬНЫМ описанием - все элементы должны логически сочетаться друг с другом
           - Ситуация должна быть описанием истории/обстоятельств, которые естественным образом требуют действия
           - Используй формулировки "вы", "ваша группа", "вы все" - ситуация для ВСЕЙ ГРУППЫ
           - НЕ раскрывай квест напрямую - пусть игроки сами поймут, что нужно делать из контекста ситуации
        
        2. КВЕСТ (как заключение/вывод из ситуации):
           - Квест должен быть ВЫВОДОМ из описанной ситуации
           - Это может быть цель персонажей, эмоциональная ситуация, из которой делаются выводы
           - Квест должен быть МАСШТАБНЫМ (не простой задачей, а полноценным приключением)
           - Квест должен решать проблему или раскрывать тайну, связанную с миром
           - Квест должен вести через разные локации и ситуации
           - Количество этапов квеста: %s (в зависимости от длительности сессии)
           - В "quest_summary" опиши квест как краткое подытоживание ситуации, а не как прямую инструкцию
        
        Верни ответ ТОЛЬКО в формате JSON (без дополнительного текста):
        {
            "situation": "Детальное описание ситуации для ВСЕЙ ГРУППЫ, которая подталкивает к действию через описание истории и обстоятельств.",
            "quest": {
                "title": "Название квеста",
                "goal": "Главная цель квеста",
                "stages": ["Этап 1", "Этап 2", "Этап 3", ...],
                "description": "Развернутое описание квеста (как он связан с миром)",
                "quest_summary": "Краткое подытоживание ситуации в виде квеста - цель персонажей или эмоциональная ситуация, из которой делаются выводы. Это заключение из ситуации, а не прямая инструкция."
            },
            "initial_location": "Название начальной локации"
        }
        
        КРИТИЧЕСКИ ВАЖНО:
        - Ситуация должна ПОДТОЛКНУТЬ игроков к действию через описание истории/обстоятельств
        - Ситуация должна быть ЕДИНЫМ ЦЕЛЬНЫМ описанием - все элементы (локация, окружение, варианты действий) должны логически сочетаться
        - Варианты действий должны естественно вытекать из описания места и быть конкретными для этой локации
        - Квест должен быть ВЫВОДОМ из ситуации, а не прямой инструкцией
        - Масштаб и сложность квеста должны соответствовать длительности сессии
        - quest_summary - это подытоживание ситуации в виде квеста (цель персонажей или эмоциональная ситуация)
        - Начальная ситуация должна быть для ВСЕЙ ГРУППЫ
        - Начальная ситуация должна использовать информацию о мире и локации
        - Отвечай ТОЛЬКО валидным JSON, без дополнительного текста
        """, worldContext.toString(), questScopeInstruction, questStagesCount);
    }
    
    /**
     * Промпт для генерации финальной сцены при завершении квеста
     */
    public static String getFinalScenePrompt(String questTitle, String questGoal) {
        return String.format("""
        Квест "%s" завершен!
        Цель квеста: %s
        
        Создай эпическую финальную сцену, которая:
        1. Показывает последствия выполнения квеста
        2. Подводит итоги приключения
        3. Дает ощущение завершенности истории
        4. Может намекать на возможные продолжения
        
        Верни ответ ТОЛЬКО в формате JSON (без дополнительного текста):
        {
            "message_type": "final_scene",
            "content": "Эпическая финальная сцена (атмосферно и эмоционально)",
            "metadata": {
                "quest_title": "%s",
                "quest_goal": "%s",
                "consequences": "Последствия выполнения квеста",
                "hints_for_continuation": "Намеки на возможные продолжения (если есть)"
            }
        }
        
        ВАЖНО:
        - message_type должен быть "final_scene"
        - content - детальное описание финальной сцены
        - metadata - информация о завершенном квесте
        """, questTitle, questGoal, questTitle, questGoal);
    }
}

