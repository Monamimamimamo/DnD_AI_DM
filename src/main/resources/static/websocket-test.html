<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D&D AI Dungeon Master - WebSocket Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a2e;
            color: #eee;
        }
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .panel {
            background: #16213e;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #0f3460;
        }
        h1 {
            color: #e94560;
            text-align: center;
        }
        h2 {
            color: #533483;
            margin-top: 0;
        }
        button {
            background: #e94560;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background: #c73650;
        }
        button:disabled {
            background: #555;
            cursor: not-allowed;
        }
        input, textarea {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #0f3460;
            border-radius: 4px;
            background: #0f3460;
            color: #eee;
            box-sizing: border-box;
        }
        textarea {
            min-height: 100px;
            font-family: monospace;
        }
        #messages {
            height: 400px;
            overflow-y: auto;
            background: #0f3460;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }
        .message {
            margin: 5px 0;
            padding: 5px;
            border-radius: 3px;
        }
        .message.system {
            background: #16213e;
            color: #aaa;
        }
        .message.dm {
            background: #533483;
            color: #fff;
        }
        .message.player {
            background: #0f3460;
            color: #fff;
        }
        .message.error {
            background: #8b0000;
            color: #fff;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
            text-align: center;
            font-weight: bold;
        }
        .status.connected {
            background: #2d5016;
            color: #90ee90;
        }
        .status.disconnected {
            background: #501616;
            color: #ff6b6b;
        }
    </style>
</head>
<body>
    <h1>üé≤ D&D AI Dungeon Master - WebSocket Test</h1>
    
    <div id="status" class="status disconnected">–û—Ç–∫–ª—é—á–µ–Ω–æ</div>
    
    <div class="container">
        <div class="panel">
            <h2>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h2>
            <div id="loginSection">
                <label for="username">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</label>
                <input type="text" id="username" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" value="test">
                <label for="password">–ü–∞—Ä–æ–ª—å:</label>
                <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å" value="test123">
                <button onclick="login()">–í–æ–π—Ç–∏</button>
                <button onclick="register()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
            </div>
            
            <div id="tokenSection" style="display: none; margin-top: 10px;">
                <div id="userInfo" style="margin-top: 10px; padding: 10px; background: #0f3460; border-radius: 4px; display: none;">
                    <p><strong>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</strong> <span id="userName"></span></p>
                    <p style="font-size: 11px; color: #aaa; margin-top: 5px;">‚úÖ –¢–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∞–∫—Ç–∏–≤–µ–Ω –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</p>
                </div>
                <details style="margin-top: 10px;">
                    <summary style="cursor: pointer; color: #aaa; font-size: 12px;">–ü–æ–∫–∞–∑–∞—Ç—å/–∏–∑–º–µ–Ω–∏—Ç—å —Ç–æ–∫–µ–Ω (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)</summary>
                    <input type="text" id="authToken" placeholder="JWT —Ç–æ–∫–µ–Ω (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞)" style="width: 100%; font-size: 11px; margin-top: 5px;">
                    <button onclick="useManualToken()" style="background: #533483; margin-top: 5px;">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–æ—Ç —Ç–æ–∫–µ–Ω</button>
                </details>
            </div>
            
            <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h2>
            <h3>–°–æ–∑–¥–∞—Ç—å –∫–∞–º–ø–∞–Ω–∏—é</h3>
            <button onclick="createCampaign()">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∫–∞–º–ø–∞–Ω–∏—é</button>
            <div id="campaignInfo" style="margin: 10px 0; padding: 10px; background: #0f3460; border-radius: 4px; display: none;">
                <p><strong>Campaign ID:</strong> <span id="campaignId"></span></p>
                <p><strong>WebSocket URL:</strong> <span id="wsUrl"></span></p>
            </div>
            <h3>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</h3>
            <label for="campaignIdInput">Campaign ID:</label>
            <input type="text" id="campaignIdInput" placeholder="–í–≤–µ–¥–∏—Ç–µ Campaign ID –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è">
            <button id="connectBtn" onclick="connect()">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –∫–∞–º–ø–∞–Ω–∏–∏</button>
            <button id="disconnectBtn" onclick="disconnect()" disabled>–û—Ç–∫–ª—é—á–∏—Ç—å—Å—è</button>
            
            <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ</h3>
            <label for="charName">–ò–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞:</label>
            <input type="text" id="charName" placeholder="–ò–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞" value="–ê—Ä–∞–≥–æ—Ä–Ω">
            <label for="charClass">–ö–ª–∞—Å—Å:</label>
            <input type="text" id="charClass" placeholder="–ö–ª–∞—Å—Å (FIGHTER, WIZARD, etc.)" value="FIGHTER">
            <label for="charRace">–†–∞—Å–∞:</label>
            <input type="text" id="charRace" placeholder="–†–∞—Å–∞ (HUMAN, ELF, etc.)" value="HUMAN">
            <label for="charLevel">–£—Ä–æ–≤–µ–Ω—å:</label>
            <input type="number" id="charLevel" placeholder="–£—Ä–æ–≤–µ–Ω—å" value="1" min="1" max="20">
            <button onclick="sendCharacterInfo()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ</button>
            
            <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞–º–ø–∞–Ω–∏–µ–π</h3>
            <div style="margin-bottom: 10px;">
                <label for="sessionDuration" style="display: block; margin-bottom: 5px; font-weight: bold;">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–µ—Å—Å–∏–∏:</label>
                <select id="sessionDuration" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                    <option value="short">–ö–æ—Ä–æ—Ç–∫–∞—è (~4 —á–∞—Å–∞) - –ú–∞–ª–µ–Ω—å–∫–∏–π –≥–æ—Ä–æ–¥–æ–∫ —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –∫–ª—é—á–µ–≤—ã–º–∏ —Ç–æ—á–∫–∞–º–∏</option>
                    <option value="medium" selected>–°—Ä–µ–¥–Ω—è—è (~30-40 —á–∞—Å–æ–≤) - –†–µ–≥–∏–æ–Ω —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –ª–æ–∫–∞—Ü–∏—è–º–∏</option>
                    <option value="long">–î–ª–∏–Ω–Ω–∞—è (–Ω–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∞) - –û–≥—Ä–æ–º–Ω—ã–π –º–∏—Ä —Å –≥–ª–æ–±–∞–ª—å–Ω—ã–º –∫–≤–µ—Å—Ç–æ–º</option>
                </select>
            </div>
            <button id="startCampaignBtn" onclick="startCampaign()" disabled style="background: #533483;">–ù–∞—á–∞—Ç—å –∫–∞–º–ø–∞–Ω–∏—é</button>
            <div id="campaignStatus" style="margin: 10px 0; padding: 10px; background: #0f3460; border-radius: 4px; display: none;">
                <p><strong>–°—Ç–∞—Ç—É—Å:</strong> <span id="statusText">–û–∂–∏–¥–∞–Ω–∏–µ</span></p>
                <p><strong>–†–æ–ª—å:</strong> <span id="roleText">-</span></p>
                <p><strong>–ò–≥—Ä–æ–∫–∏:</strong> <span id="playersList">-</span></p>
            </div>
            <h3>–î–µ–π—Å—Ç–≤–∏–µ</h3>
            <label for="actionText">–í–∞—à–µ –¥–µ–π—Å—Ç–≤–∏–µ:</label>
            <textarea id="actionText" placeholder="–û–ø–∏—à–∏—Ç–µ –≤–∞—à–µ –¥–µ–π—Å—Ç–≤–∏–µ..."></textarea>
            <button onclick="sendAction()" id="actionBtn" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ</button>
        </div>
        
        <div class="panel">
            <h2>–°–æ–æ–±—â–µ–Ω–∏—è</h2>
            <div id="messages"></div>
        </div>
    </div>

    <script>
        let ws = null;
        let campaignId = null;
        let characterName = null;
        let role = null; // "host" –∏–ª–∏ "player"
        let campaignStatus = "waiting"; // "waiting" –∏–ª–∏ "started"
        let authToken = localStorage.getItem('authToken') || null;
        let currentUsername = null;

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = function() {
            if (authToken) {
                const tokenInput = document.getElementById('authToken');
                if (tokenInput) {
                    tokenInput.value = authToken;
                }
                document.getElementById('tokenSection').style.display = 'block';
                document.getElementById('loginSection').style.display = 'none';
                validateToken();
            }
        };

        async function login() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            
            if (!username || !password) {
                alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø–∞—Ä–æ–ª—å');
                return;
            }
            
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await response.json();
                if (data.success) {
                    authToken = data.token;
                    currentUsername = data.username;
                    localStorage.setItem('authToken', authToken);
                    
                    // –ë–µ–∑–æ–ø–∞—Å–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞, –µ—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
                    const tokenInput = document.getElementById('authToken');
                    if (tokenInput) {
                        tokenInput.value = authToken;
                    }
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é —Å —Ç–æ–∫–µ–Ω–æ–º –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
                    document.getElementById('tokenSection').style.display = 'block';
                    document.getElementById('loginSection').style.display = 'none';
                    document.getElementById('userName').textContent = currentUsername;
                    document.getElementById('userInfo').style.display = 'block';
                    addMessage('system', `‚úÖ –í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω: ${currentUsername}`);
                    addMessage('system', '‚úÖ –¢–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –∏ –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏');
                } else {
                    addMessage('error', `‚ùå –û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ${data.error}`);
                }
            } catch (error) {
                addMessage('error', `‚ùå –û—à–∏–±–∫–∞: ${error.message}`);
            }
        }

        async function register() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            
            if (!username || !password) {
                alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø–∞—Ä–æ–ª—å');
                return;
            }
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º email –∏–∑ username –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
            const email = username + '@test.local';
            
            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, email, password })
                });
                
                const data = await response.json();
                if (data.success) {
                    addMessage('system', `‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞: ${username}. –¢–µ–ø–µ—Ä—å –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –≤—Ö–æ–¥.`);
                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–ø–æ–ª–Ω—è–µ–º –≤—Ö–æ–¥ –ø–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
                    login();
                } else {
                    addMessage('error', `‚ùå –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ${data.error}`);
                }
            } catch (error) {
                addMessage('error', `‚ùå –û—à–∏–±–∫–∞: ${error.message}`);
            }
        }

        function useManualToken() {
            const tokenInput = document.getElementById('authToken');
            if (!tokenInput) {
                alert('–ü–æ–ª–µ —Ç–æ–∫–µ–Ω–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
                return;
            }
            const token = tokenInput.value.trim();
            if (token) {
                authToken = token;
                localStorage.setItem('authToken', token);
                validateToken();
            } else {
                alert('–í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω');
            }
        }

        async function validateToken() {
            if (!authToken) return;
            
            try {
                const response = await fetch('/api/auth/me', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const data = await response.json();
                if (data.success) {
                    currentUsername = data.username;
                    document.getElementById('userName').textContent = currentUsername;
                    document.getElementById('userInfo').style.display = 'block';
                    document.getElementById('tokenSection').style.display = 'block';
                    document.getElementById('loginSection').style.display = 'none';
                } else {
                    authToken = null;
                    localStorage.removeItem('authToken');
                    document.getElementById('tokenSection').style.display = 'none';
                    document.getElementById('loginSection').style.display = 'block';
                    addMessage('error', `‚ùå –¢–æ–∫–µ–Ω –Ω–µ–≤–∞–ª–∏–¥–µ–Ω: ${data.error}`);
                }
            } catch (error) {
                addMessage('error', `‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–æ–∫–µ–Ω–∞: ${error.message}`);
            }
        }

        async function createCampaign() {
            if (!authToken) {
                alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –≤—Ö–æ–¥ –∏–ª–∏ —É–∫–∞–∂–∏—Ç–µ —Ç–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏!');
                return;
            }
            
            try {
                const response = await fetch('/api/campaigns', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({})
                });
                
                const data = await response.json();
                if (data.success) {
                    campaignId = data.campaign.session_id;
                    document.getElementById('campaignId').textContent = campaignId;
                    document.getElementById('wsUrl').textContent = data.websocket_url || `ws://${window.location.host}/ws/campaign/${campaignId}`;
                    document.getElementById('campaignInfo').style.display = 'block';
                    document.getElementById('campaignIdInput').value = campaignId;
                    addMessage('system', `‚úÖ –ö–∞–º–ø–∞–Ω–∏—è —Å–æ–∑–¥–∞–Ω–∞: ${campaignId}`);
                    
                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Å–æ–∑–¥–∞–Ω–Ω–æ–π –∫–∞–º–ø–∞–Ω–∏–∏
                    setTimeout(() => {
                        connectToCampaign(campaignId);
                    }, 100);
                } else {
                    addMessage('error', `‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞–º–ø–∞–Ω–∏–∏: ${data.error}`);
                }
            } catch (error) {
                addMessage('error', `‚ùå –û—à–∏–±–∫–∞: ${error.message}`);
            }
        }
        
        function connectToCampaign(campaignIdToConnect) {
            if (!authToken) {
                alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –≤—Ö–æ–¥ –∏–ª–∏ —É–∫–∞–∂–∏—Ç–µ —Ç–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏!');
                return;
            }
            
            campaignId = campaignIdToConnect || document.getElementById('campaignIdInput').value.trim();
            if (!campaignId) {
                alert('–í–≤–µ–¥–∏—Ç–µ Campaign ID –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é –∫–∞–º–ø–∞–Ω–∏—é!');
                return;
            }
            
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/campaign/${campaignId}?token=${encodeURIComponent(authToken)}`;
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = function() {
                addMessage('system', '‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É');
                document.getElementById('status').textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
                document.getElementById('status').className = 'status connected';
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('disconnectBtn').disabled = false;
                document.getElementById('campaignStatus').style.display = 'block';
            };
            
            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                handleMessage(data);
            };
            
            ws.onerror = function(error) {
                console.error('WebSocket error:', error);
            };
            
            ws.onclose = async function(event) {
                let message = 'üîå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ';
                
                if (event.code === 1006) {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–∞–º–ø–∞–Ω–∏–∏ –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
                    try {
                        const statusResponse = await fetch(`/api/campaigns/${campaignId}/status`, {
                            method: 'GET',
                            headers: { 'Authorization': `Bearer ${authToken}` }
                        });
                        
                        if (statusResponse.ok) {
                            const statusData = await statusResponse.json();
                            if (statusData.isHostConnected === false) {
                                // –•–æ—Å—Ç –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω
                                message = '‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è: —Ö–æ—Å—Ç –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω –∫ –∫–∞–º–ø–∞–Ω–∏–∏. –û–∂–∏–¥–∞–π—Ç–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —Ö–æ—Å—Ç–∞.';
                            } else if (statusData.isStarted === true) {
                                // –ö–∞–º–ø–∞–Ω–∏—è –Ω–∞—á–∞—Ç–∞
                                message = '‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è: –∫–∞–º–ø–∞–Ω–∏—è —É–∂–µ –Ω–∞—á–∞—Ç–∞ –∏ –∏–º–µ–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏. –ù–æ–≤—ã–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∑–∞–ø—Ä–µ—â–µ–Ω—ã.';
                            } else {
                                // –î—Ä—É–≥–∞—è –ø—Ä–∏—á–∏–Ω–∞
                                message = '‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ ID –∫–∞–º–ø–∞–Ω–∏–∏ –∏ —Ç–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.';
                            }
                        } else if (statusResponse.status === 404) {
                            message = '‚ùå –ö–∞–º–ø–∞–Ω–∏—è —Å ID "' + campaignId + '" –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.';
                        } else if (statusResponse.status === 401 || statusResponse.status === 403) {
                            message = '‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.';
                        } else {
                            // –î—Ä—É–≥–∞—è –æ—à–∏–±–∫–∞
                            message = '‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ ID –∫–∞–º–ø–∞–Ω–∏–∏ –∏ —Ç–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.';
                        }
                    } catch (error) {
                        // –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                        message = '‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ ID –∫–∞–º–ø–∞–Ω–∏–∏ –∏ —Ç–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.';
                    }
                } else if (event.code === 1008) {
                    message = '‚ùå –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.';
                } else if (event.code !== 1000) {
                    message = `üîå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ (–∫–æ–¥: ${event.code})`;
                }
                
                addMessage('error', message);
                document.getElementById('status').textContent = '–û—Ç–∫–ª—é—á–µ–Ω–æ';
                document.getElementById('status').className = 'status disconnected';
                document.getElementById('connectBtn').disabled = false;
                document.getElementById('disconnectBtn').disabled = true;
            };
        }

        function connect() {
            const inputCampaignId = document.getElementById('campaignIdInput').value.trim();
            if (!inputCampaignId) {
                alert('–í–≤–µ–¥–∏—Ç–µ Campaign ID –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é –∫–∞–º–ø–∞–Ω–∏—é!');
                return;
            }
            
            connectToCampaign(inputCampaignId);
        }

        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
            }
        }

        function handleMessage(data) {
            console.log('–ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ:', data);
            
            switch(data.type) {
                case 'campaign_created':
                    role = 'host';
                    document.getElementById('roleText').textContent = '–•–æ—Å—Ç';
                    document.getElementById('startCampaignBtn').disabled = false;
                    addMessage('system', `üéÆ –ö–∞–º–ø–∞–Ω–∏—è —Å–æ–∑–¥–∞–Ω–∞: ${data.campaign_id}`);
                    addMessage('system', `üìñ –ù–∞—á–∞–ª—å–Ω–∞—è —Å—Ü–µ–Ω–∞: ${data.initial_scene}`);
                    if (data.main_quest) {
                        addMessage('system', `üéØ –ö–≤–µ—Å—Ç: ${data.main_quest.title || data.main_quest.goal}`);
                    }
                    addMessage('system', '‚è≥ –î–æ–∂–¥–∏—Ç–µ—Å—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∏–≥—Ä–æ–∫–æ–≤ –∏ –Ω–∞–∂–º–∏—Ç–µ "–ù–∞—á–∞—Ç—å –∫–∞–º–ø–∞–Ω–∏—é"');
                    break;
                    
                case 'campaign_loaded':
                    role = data.role || 'host';
                    document.getElementById('roleText').textContent = role === 'host' ? '–•–æ—Å—Ç' : '–ò–≥—Ä–æ–∫';
                    campaignStatus = data.status || 'waiting';
                    document.getElementById('statusText').textContent = campaignStatus === 'started' ? '–ù–∞—á–∞—Ç–∞' : '–û–∂–∏–¥–∞–Ω–∏–µ';
                    
                    if (role === 'host') {
                        document.getElementById('startCampaignBtn').disabled = campaignStatus === 'started';
                        addMessage('system', `üìÇ –ö–∞–º–ø–∞–Ω–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞: ${data.campaign_id}`);
                        if (data.message) {
                            addMessage('system', data.message);
                        } else if (campaignStatus !== 'started') {
                            addMessage('system', '‚è≥ –î–æ–∂–¥–∏—Ç–µ—Å—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∏–≥—Ä–æ–∫–æ–≤ –∏ –Ω–∞–∂–º–∏—Ç–µ "–ù–∞—á–∞—Ç—å –∫–∞–º–ø–∞–Ω–∏—é"');
                        }
                    } else {
                        document.getElementById('startCampaignBtn').disabled = true;
                        addMessage('system', `üìÇ –í—ã –ø–æ–¥–∫–ª—é—á–∏–ª–∏—Å—å –∫ –∫–∞–º–ø–∞–Ω–∏–∏: ${data.campaign_id}`);
                    }
                    
                    if (data.characters && data.characters.length > 0) {
                        addMessage('system', `üë• –ü–µ—Ä—Å–æ–Ω–∞–∂–∏ –≤ –∫–∞–º–ø–∞–Ω–∏–∏: ${data.characters.map(c => c.name).join(', ')}`);
                    }
                    break;
                    
                case 'campaign_joined':
                    role = data.role || 'player';
                    document.getElementById('roleText').textContent = role === 'host' ? '–•–æ—Å—Ç' : '–ò–≥—Ä–æ–∫';
                    campaignStatus = data.status || 'waiting';
                    document.getElementById('statusText').textContent = campaignStatus === 'started' ? '–ù–∞—á–∞—Ç–∞' : '–û–∂–∏–¥–∞–Ω–∏–µ';
                    document.getElementById('startCampaignBtn').disabled = role !== 'host' || campaignStatus === 'started';
                    
                    addMessage('system', `üìÇ ${data.message || '–í—ã –ø–æ–¥–∫–ª—é—á–∏–ª–∏—Å—å –∫ –∫–∞–º–ø–∞–Ω–∏–∏: ' + data.campaign_id}`);
                    
                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä—Å–æ–Ω–∞–∂–∞, –µ—Å–ª–∏ –æ–Ω –±—ã–ª
                    if (data.character_name) {
                        characterName = data.character_name;
                        if (data.character) {
                            addMessage('system', `‚úÖ –ü–µ—Ä—Å–æ–Ω–∞–∂ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: ${characterName}`);
                            addMessage('system', `üìä –ö–ª–∞—Å—Å: ${data.character.class}, –†–∞—Å–∞: ${data.character.race}, –£—Ä–æ–≤–µ–Ω—å: ${data.character.level}`);
                        }
                    }
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–ª—é—á–µ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–∞–º–ø–∞–Ω–∏–∏
                    if (data.current_scene) {
                        addMessage('system', `üìñ –¢–µ–∫—É—â–∞—è —Å—Ü–µ–Ω–∞: ${data.current_scene}`);
                    }
                    if (data.current_location) {
                        addMessage('system', `üó∫Ô∏è –õ–æ–∫–∞—Ü–∏—è: ${data.current_location}`);
                    }
                    if (data.main_quest) {
                        const questTitle = data.main_quest.title || data.main_quest.goal || JSON.stringify(data.main_quest);
                        addMessage('system', `üéØ –ö–≤–µ—Å—Ç: ${questTitle}`);
                    }
                    
                    if (campaignStatus === 'started') {
                        addMessage('system', 'üéÆ –ö–∞–º–ø–∞–Ω–∏—è —É–∂–µ –Ω–∞—á–∞—Ç–∞');
                        document.getElementById('actionBtn').disabled = !characterName;
                    } else {
                        if (role === 'host') {
                            addMessage('system', '‚è≥ –î–æ–∂–¥–∏—Ç–µ—Å—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∏–≥—Ä–æ–∫–æ–≤ –∏ –Ω–∞–∂–º–∏—Ç–µ "–ù–∞—á–∞—Ç—å –∫–∞–º–ø–∞–Ω–∏—é"');
                        } else {
                            addMessage('system', '‚è≥ –û–∂–∏–¥–∞–π—Ç–µ –Ω–∞—á–∞–ª–∞ –∫–∞–º–ø–∞–Ω–∏–∏ –æ—Ç —Ö–æ—Å—Ç–∞');
                        }
                    }
                    break;
                    
                case 'player_joined':
                    addMessage('system', `üëã ${data.message}`);
                    break;
                    
                case 'player_left':
                    addMessage('system', `üëã ${data.message}`);
                    break;
                    
                case 'host_left':
                    addMessage('error', `‚ùå ${data.message}`);
                    addMessage('system', '‚è≥ –û–∂–∏–¥–∞–π—Ç–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —Ö–æ—Å—Ç–∞. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–Ω–æ –∑–∞–∫—Ä—ã—Ç—ã.');
                    // –û—Ç–∫–ª—é—á–∞–µ–º—Å—è, —Ç–∞–∫ –∫–∞–∫ —Ö–æ—Å—Ç –ø–æ–∫–∏–Ω—É–ª –∫–∞–º–ø–∞–Ω–∏—é
                    if (ws) {
                        ws.close();
                    }
                    break;
                    
                case 'player_character_added':
                    addMessage('system', `üë§ ${data.message}`);
                    break;
                    
                case 'players_list':
                    document.getElementById('playersList').textContent = data.players.join(', ') || '–ù–µ—Ç –∏–≥—Ä–æ–∫–æ–≤';
                    break;
                    
                case 'campaign_started':
                    campaignStatus = 'started';
                    document.getElementById('statusText').textContent = '–ù–∞—á–∞—Ç–∞';
                    document.getElementById('startCampaignBtn').disabled = true;
                    document.getElementById('actionBtn').disabled = false;
                    addMessage('system', `üéÆ ${data.message}`);
                    // –ù–ï –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º initial_situation –∑–¥–µ—Å—å, —Ç–∞–∫ –∫–∞–∫ –æ–Ω–∞ —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º "situation"
                    if (data.current_location) {
                        addMessage('system', `üó∫Ô∏è –õ–æ–∫–∞—Ü–∏—è: ${data.current_location}`);
                    }
                    break;
                    
                case 'request_character':
                    addMessage('system', `üí¨ ${data.message}`);
                    break;
                    
                case 'character_added':
                    characterName = data.character.name;
                    addMessage('system', `‚úÖ –ü–µ—Ä—Å–æ–Ω–∞–∂ –¥–æ–±–∞–≤–ª–µ–Ω: ${characterName}`);
                    addMessage('system', `üìä –ö–ª–∞—Å—Å: ${data.character.class}, –†–∞—Å–∞: ${data.character.race}, –£—Ä–æ–≤–µ–Ω—å: ${data.character.level}`);
                    // –ï—Å–ª–∏ –∫–∞–º–ø–∞–Ω–∏—è —É–∂–µ –Ω–∞—á–∞—Ç–∞, –º–æ–∂–Ω–æ —Å—Ä–∞–∑—É –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å
                    if (campaignStatus === 'started') {
                        document.getElementById('actionBtn').disabled = false;
                    }
                    break;
                    
                case 'situation':
                    // –°–∏—Ç—É–∞—Ü–∏—è –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∫–≤–µ—Å—Ç –∫–∞–∫ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ
                    const situationText = data.situation || data.message || '';
                    addMessage('dm', `üìç ${situationText}`);
                    if (data.current_location) {
                        addMessage('system', `üó∫Ô∏è –õ–æ–∫–∞—Ü–∏—è: ${data.current_location}`);
                    }
                    break;
                    
                case 'dm_response':
                    if (data.character_name && data.character_name !== characterName) {
                        addMessage('player', `‚öîÔ∏è ${data.character_name}: ${data.action}`);
                    }
                    addMessage('dm', `üé≠ ${data.dm_response}`);
                    if (data.current_location) {
                        addMessage('system', `üó∫Ô∏è –õ–æ–∫–∞—Ü–∏—è: ${data.current_location}`);
                    }
                    if (data.success !== undefined) {
                        addMessage('system', `‚úÖ –£—Å–ø–µ—Ö: ${data.success}`);
                    }
                    if (data.quest_advanced) {
                        addMessage('system', 'üéØ –ü—Ä–æ–≥—Ä–µ—Å—Å –∫–≤–µ—Å—Ç–∞!');
                    }
                    if (data.story_completed) {
                        addMessage('system', 'üèÜ –ò—Å—Ç–æ—Ä–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!');
                    }
                    break;
                    
                case 'world_info':
                    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ –º–∏—Ä–∞ –∫–∞–∫ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç DM
                    addMessage('dm', data.message);
                    break;
                    
                case 'quest_info':
                    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–≤–µ—Å—Ç–µ –∫–∞–∫ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç —Å–∏—Å—Ç–µ–º—ã
                    addMessage('system', data.message);
                    break;
                    
                case 'error':
                    addMessage('error', `‚ùå –û—à–∏–±–∫–∞: ${data.message}`);
                    break;
                    
                default:
                    addMessage('system', `üì® –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: ${JSON.stringify(data)}`);
            }
        }

        function sendCharacterInfo() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                alert('–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ —Å–µ—Ä–≤–µ—Ä—É!');
                return;
            }
            
            const message = {
                type: 'character_info',
                name: document.getElementById('charName').value,
                class: document.getElementById('charClass').value,
                race: document.getElementById('charRace').value,
                level: parseInt(document.getElementById('charLevel').value) || 1
            };
            
            ws.send(JSON.stringify(message));
            addMessage('player', `üë§ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ: ${message.name}`);
        }

        function startCampaign() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                alert('–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ —Å–µ—Ä–≤–µ—Ä—É!');
                return;
            }
            
            if (role !== 'host') {
                alert('–¢–æ–ª—å–∫–æ —Ö–æ—Å—Ç –º–æ–∂–µ—Ç –Ω–∞—á–∞—Ç—å –∫–∞–º–ø–∞–Ω–∏—é!');
                return;
            }
            
            const sessionDuration = document.getElementById('sessionDuration').value;
            
            const message = {
                type: 'start_campaign',
                session_duration: sessionDuration
            };
            
            ws.send(JSON.stringify(message));
            addMessage('system', 'üéÆ –ó–∞–ø—Ä–æ—Å –Ω–∞ –Ω–∞—á–∞–ª–æ –∫–∞–º–ø–∞–Ω–∏–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω...');
        }

        function sendAction() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                alert('–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ —Å–µ—Ä–≤–µ—Ä—É!');
                return;
            }
            
            if (campaignStatus !== 'started') {
                alert('–ö–∞–º–ø–∞–Ω–∏—è –µ—â–µ –Ω–µ –Ω–∞—á–∞—Ç–∞! –î–æ–∂–¥–∏—Ç–µ—Å—å –Ω–∞—á–∞–ª–∞ –æ—Ç —Ö–æ—Å—Ç–∞.');
                return;
            }
            
            if (!characterName) {
                alert('–°–Ω–∞—á–∞–ª–∞ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ!');
                return;
            }
            
            const action = document.getElementById('actionText').value.trim();
            if (!action) {
                alert('–í–≤–µ–¥–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ!');
                return;
            }
            
            const message = {
                type: 'action',
                action: action
            };
            
            ws.send(JSON.stringify(message));
            addMessage('player', `‚öîÔ∏è –î–µ–π—Å—Ç–≤–∏–µ: ${action}`);
            document.getElementById('actionText').value = '';
        }

        function addMessage(type, text) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = `[${new Date().toLocaleTimeString()}] ${text}`;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

    </script>
</body>
</html>
